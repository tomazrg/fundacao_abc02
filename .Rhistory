library(tidyverse)
library(gsheet)
library(broom)
library(metafor)
library(dplyr)
library(ggthemes)
library(plyr)
library(janitor)
library(metafor)
library(cowplot)
library(rio)
ma = gsheet2tbl("https://docs.google.com/spreadsheets/d/1WVUeXTH_o9kTgryR1ZszdNFJjWt_PegmhxclXVSXVgk/edit?usp=sharing")
head(ma)
labels <- c("BIX+PROT+TRIFL" = "BIX+PROT+TRIFL", "_CHECK" = "Non-treated", "FLUX+PYRA" = "FLUX+PYRA")
yield = ma %>%
filter(ai %in% c("BIX+PROT+TRIFL", "_CHECK", "FLUX+PYRA")) %>%
ggplot(aes(yld))+
geom_histogram(color = "white", fill = "darkred")+
facet_wrap(~ai,labeller = labeller(ai = labels))+
theme_few()+
labs(x = "Yield (kg/ha)",
y = "Frequency")+
theme(text = element_text(face = "bold",size = 14))
ggsave("fig/yield.png", bg = "white", width = 10, height = 8)
yield_year = ma %>%
filter(ai %in% c("BIX+PROT+TRIFL", "_CHECK", "FLUX+PYRA")) %>%
ggplot(aes(as.factor(year),yld))+
#geom_histogram(color = "white", fill = "darkgreen")+
geom_boxplot(fill = NA, color = "black", size = 1)+
facet_wrap(~ai,labeller = labeller(ai = labels))+
theme_few()+
labs(x = "Year",
y = "Yield (kg/ha)")+
#coord_flip()+
theme(text = element_text(face = "bold",size = 14),
strip.text = element_blank())
ggsave("fig/yield_year.png", bg = "white", width = 10, height = 8)
plot_grid(yield,yield_year, labels = c("AUTO"), ncol = 1)
severity = ma %>%
filter(ai %in% c("BIX+PROT+TRIFL", "_CHECK", "FLUX+PYRA")) %>%
ggplot(aes(sev))+
geom_histogram(color = "white", fill = "darkgreen")+
facet_wrap(~ai,labeller = labeller(ai = labels))+
theme_few()+
labs(x = "Severity (%)",
y = "Frequency")+
theme(text = element_text(face = "bold",size = 14))
ggsave("fig/severity.png", bg = "white", width = 10, height = 8)
severity_year = ma %>%
filter(ai %in% c("BIX+PROT+TRIFL", "_CHECK", "FLUX+PYRA")) %>%
ggplot(aes(as.factor(year),sev))+
#geom_histogram(color = "white", fill = "darkgreen")+
geom_boxplot(fill = NA, color = "black", size = 1)+
facet_wrap(~ai,labeller = labeller(ai = labels))+
theme_few()+
labs(x = "Year",
y = "Severity (%)")+
#coord_flip()+
theme(text = element_text(face = "bold",size = 14),
strip.text = element_blank())
ggsave("fig/severity_year.png", bg = "white", width = 10, height = 8)
plot_grid(severity,severity_year, labels = c("AUTO"), ncol = 1)
ggsave("fig/frequency_boxplot_severity.png",
bg = "white", height = 8,width = 10)
ma
ma1 <- ma %>%
#filter(ai %in% c("BIX+PROT+TRIFL", "_CHECK", "FLUX+PYRA")) %>%
dplyr::group_by(study, year, location, state, ai) %>%
dplyr::summarise(mean_sev = mean(sev),
mean_yld = mean(yld))
ma_sev <- ma %>%
dplyr::filter(!is.na(sev)) %>%
dplyr::filter(!is.na(yld)) %>%
dplyr::filter(yld>0) %>%
dplyr::group_by(study, year) %>%
dplyr::select(ai, block, sev) %>%
dplyr::group_by(study, year) %>%
do(tidy(aov(.$sev ~ .$ai + factor(.$block)))) %>%
dplyr::filter(term == "Residuals") %>%
dplyr::select(1,2,6) %>%
set_names(c("study", "year", "v_sev"))
ma_yld <- ma %>%
dplyr::filter(!is.na(sev)) %>%
dplyr::filter(!is.na(yld)) %>%
dplyr::filter(yld>0) %>%
dplyr::group_by(study, year) %>%
dplyr::select(ai, block, yld) %>%
dplyr::group_by(study, year) %>%
do(tidy(aov(.$yld ~ .$ai + factor(.$block)))) %>%
dplyr::filter(term == "Residuals") %>%
dplyr::select(1,2,6) %>%
set_names(c("study", "year", "v_yld"))
qmr = left_join(ma_sev, ma_yld)
ma_trial = dplyr::full_join(ma1, qmr)
ma3 = ma_trial %>%
filter(!is.na(mean_sev)) %>%
filter(!is.na(mean_yld)) %>%
filter(!is.na(v_sev)) %>%
filter(!is.na(v_yld)) %>%
filter(ai %in% c("BIX+PROT+TRIFL", "_CHECK", "FLUX+PYRA"))
summary(ma3)
ma3$ai <- revalue(ma3$ai, c("_CHECK" = "AACHECK"))
ma3$ai <- revalue(ma3$ai, c("BIX+PROT+TRIFL" = "BIX + PROT + TRIFL"))
ma3$ai <- revalue(ma3$ai, c("FLUX+PYRA" = "FLUX + PYRA"))
ma3$study = as.factor(ma3$study)
unique(ma3$study)
#ma3_unique <- ma3 %>%
# dplyr::distinct(study, .keep_all = TRUE)
ma3 = ma3 %>% # REVISAR
dplyr::group_by(ai,study,year) %>%
dplyr::summarise(
mean_yld = mean(mean_yld),
v_yld = mean(v_yld),
mean_sev = mean(mean_sev),
v_sev = mean(v_sev)
)
ma_check = ma3 %>%
ungroup() %>%
dplyr::filter(ai == "AACHECK")%>%
group_by(study) %>%
dplyr::mutate(check = ai, sev_check = mean_sev,
v_sev_check = v_sev, yld_check = mean_yld, v_yld_check = v_yld ) %>%
dplyr::select(study, yld_check, v_yld_check, sev_check, v_sev_check)
ma_check = ma_check %>%
filter(!is.na(yld_check)) %>%
filter(!is.na(v_yld_check)) %>%
filter(!is.na(sev_check)) %>%
filter(!is.na(v_sev_check))
ma_check = ma_check %>%
dplyr::group_by(study) %>%
dplyr::summarise(
yld_check = mean(yld_check),
v_yld_check = mean(v_yld_check),
sev_check = mean(sev_check),
v_sev_check = mean(v_sev_check)
)
ma_data = ma3 %>%
full_join(ma_check)
ma_sev <- ma_data %>%
filter(mean_sev != "NA") %>%
filter(mean_sev>0)
hist(ma_sev$mean_sev)
ma_sev <- ma_sev %>%
mutate(log_sev = log(mean_sev))
hist(ma_sev$log_sev)
ma_sev$vi_sev <- with(ma_sev, v_sev / (4 * mean_sev^2))
summary(ma_sev$vi_sev)
ma_sev = ma_sev %>%
filter(!is.na(mean_yld))
ma_sev <- ma_sev %>%
filter(!is.na(mean_yld)) %>%
filter(!is.na(mean_sev)) %>%
group_by(study) %>%
dplyr::mutate(n2 = n()) %>%
filter(n2 != 1)
unique(ma_sev$n2)
summary(ma_sev)
# Overall
mv_sev <- rma.mv(log_sev, vi_sev,
mods = ~ai,
random = list(~ai | factor(study)),
struct = "HCS",
method = "ML",
#control = list(optimizer = "nlm"),
data = ma_sev)
summary(mv_sev)
mv_sev_means <- emmprep(mv_sev)
library(emmeans)
mv_sev_emmeans <- emmeans(mv_sev_means, ~ ai)
pwpm(mv_sev_emmeans)
emmeans_summary <- summary(mv_sev_emmeans)
emmeans_df <- as.data.frame(emmeans_summary)
colnames(emmeans_df) <- c("ai", "emmeans", "SE", "df", "lower.CL", "upper.CL")
emmeans_df$emmeans = exp(emmeans_df$emmeans)
emmeans_df$SE = exp(emmeans_df$SE)
emmeans_df$lower.CL = exp(emmeans_df$lower.CL)
emmeans_df$upper.CL = exp(emmeans_df$upper.CL)
library(multcomp)
#cld(mv_sev_emmeans)
efficacy_sev <- data.frame(cbind(
(1 - exp(mv_sev$b)) * 100,
(1 - exp(mv_sev$ci.lb)) * 100,
(1 - exp(mv_sev$ci.ub)) * 100
))
efficacy_sev
